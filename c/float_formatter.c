#include <stdint.h>
#include <stdio.h>
#include <string.h>

// H'XYのX+Yを計算したテーブル。H'12のNibble Sumはnibble_sum[0x12]で取得できる
uint8_t nibble_sum[256] = {
    0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,
    0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,
    0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,
    0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,
    0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,
    0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,
    0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,
    0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,
    0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,
    0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,
    0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,
    0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,
    0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,
    0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,
    0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,
    0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1D,0x1E
};


uint8_t frame_sum(uint16_t id, uint8_t *data, uint8_t tail)
{
    uint8_t sum = 0;
    id |= 0x800;
    sum += ((id >> 8) & 0x0F) + ((id >> 4) & 0x0F) + (id & 0x0F);
    sum += nibble_sum[data[0]];
    sum += nibble_sum[data[1]];
    sum += nibble_sum[data[2]];
    sum += nibble_sum[data[3]];
    sum += nibble_sum[data[4]];
    sum += nibble_sum[data[5]];
    sum += nibble_sum[data[6]];
    sum += tail & 0x0F;
    sum &= 0x0F;
    sum = (0x10 - sum) & 0x0F;
    return sum;
}

char tmp_buf1[16];
char tmp_buf2[16];
void p1l1_formatter(uint8_t *buf, int16_t min, int16_t max)
{
    int32_t min_inter = 0, max_inter = 0; // 整数部
    int32_t min_frac = 0, max_frac = 0;  // 小数部

    min_inter = min / 5000;
    max_inter = max / 5000;
    min_frac = min % 5000;
    if (0 > min_frac) min_frac *= -1;
    max_frac = max % 5000;
    if (0 > max_frac) max_frac *= -1;

    sprintf(tmp_buf1, "%d.%d", min_inter, min_frac);
    sprintf(tmp_buf2, "%d.%d", max_inter, max_frac);
    sprintf(buf, "abcd %7s/%7sV ", tmp_buf1, tmp_buf2);
}


// テーブル作成
#if 0
int main(void) {
    for (int i = 0; i < 256; i++) {
        int sum = (i & 0x0F) + ((i >> 4) & 0x0F);
        printf("0x%02X,", sum);
        if (i % 16 == 15) printf("\n");
    }
    return 0;
}
#endif


uint8_t buf[0x100] = {0};
int main(void)
{
    memset(buf, 0, 0x100);
    p1l1_formatter(buf, 0x8000, 0x7fff);
    printf("%s\n", buf);

    memset(buf, 0, 0x100);
    p1l1_formatter(buf, 0x0, 0x1);
    printf("%s\n", buf);

    memset(buf, 0, 0x100);
    p1l1_formatter(buf, 0x1234, 0xffff);
    printf("%s\n", buf);
}
